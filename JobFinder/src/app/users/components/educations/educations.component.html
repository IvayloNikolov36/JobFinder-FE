<form [formGroup]="educationsForm">
  @for (e of educationsFormArray.controls; track $index; let i = $index) {
  <div [formGroup]="e" class="mt-1 mb-3">

    <mat-accordion class="full-width">
      <mat-expansion-panel class="mt-3" [expanded]="openedPanel === i" (opened)="openExpansionPanel(i)">
        <mat-expansion-panel-header>
          <mat-panel-title class="fs-6 fst-italic">
            <span class="fs-4">Education Info {{i + 1}}</span>
          </mat-panel-title>
        </mat-expansion-panel-header>
        <ng-template matExpansionPanelContent>

          <div class="d-flex justify-content-start gap-3 mt-4">
            <mat-form-field class="half-width">
              <input matInput [matDatepicker]="fromDateEducationPicker" placeholder="Choose start date"
                formControlName="fromDate">
              <mat-datepicker-toggle matSuffix [for]="fromDateEducationPicker"></mat-datepicker-toggle>
              <mat-datepicker #fromDateEducationPicker></mat-datepicker>
              <mat-hint>Enter start date.</mat-hint>
              @if (e.controls['fromDate']?.touched && e.controls['fromDate']?.errors?.['required']) {
              <mat-error>Start date is required!</mat-error>
              }
            </mat-form-field>

            <mat-form-field class="half-width">
              <input matInput [matDatepicker]="toDateEducationPicker" placeholder="Choose end date"
                formControlName="toDate">
              <mat-datepicker-toggle matSuffix [for]="toDateEducationPicker"></mat-datepicker-toggle>
              <mat-datepicker #toDateEducationPicker></mat-datepicker>
              <mat-hint>End date.</mat-hint>
            </mat-form-field>
          </div>

          <div class="d-flex justify-content-start gap-3 mt-4">
            <mat-form-field class="half-width">
              <input matInput type="text" placeholder="Organization" formControlName="organization">
              <mat-hint>Enter Organization.</mat-hint>
              @if (e.controls['organization']?.touched && e.controls['organization']?.errors?.['required']) {
              <mat-error>Organization is required!</mat-error>
              }
              @if (e.controls['organization']?.errors?.['minlength']) {
              <mat-error>
                Organization length must be at least
                {{e.controls['organization'].errors?.['minlength']['requiredLength']}} characters!
              </mat-error>
              }
              @if (e.controls['organization']?.errors?.['maxlength']) {
              <mat-error>
                Organization length must be no more than
                {{e.controls['organization'].errors?.['maxlength']['requiredLength'] }} characters!
              </mat-error>
              }
            </mat-form-field>

            <mat-form-field class="half-width">
              <input matInput type="text" placeholder="Location" formControlName="location">
              <mat-hint>Enter Location.</mat-hint>
              @if (e.controls['location']?.touched && e.controls['location']?.errors?.['required']) {
              <mat-error>Location is required!</mat-error>
              }
              @if (e.controls['location']?.errors?.['minlength']) {
              <mat-error>
                Location length must be at least
                {{e.controls['location'].errors?.['minlength']['requiredLength']}} characters!
              </mat-error>
              }
              @if (e.controls['location']?.errors?.['maxlength']) {
              <mat-error>
                Location length must be no more than
                {{e.controls['location'].errors?.['maxlength']['requiredLength']}} characters!
              </mat-error>
              }
            </mat-form-field>
          </div>

          <div class="d-flex justify-content-start gap-3 mt-4">
            <mat-form-field class="half-width">
              <mat-label>Education Level</mat-label>
              <mat-select formControlName="educationLevel" [compareWith]="compareFn">
                @for (e of educationLevels(); track e.id) {
                <mat-option [value]="e">{{ e.name }}</mat-option>
                }
              </mat-select>
              <mat-hint>Select education level.</mat-hint>
              @if (e.controls['educationLevel']?.touched && e.controls['educationLevel'].errors?.['required']) {
              <mat-error>Education level is required!</mat-error>
              }
            </mat-form-field>

            <mat-form-field class="half-width">
              <input matInput type="text" placeholder="Major" formControlName="major">
              <mat-hint>Enter major.</mat-hint>
              @if (e.controls['major']?.touched && e.controls['major']?.errors?.['required']) {
              <mat-error>Major is required!</mat-error>
              }
              @if (e.controls['major']?.errors?.['minlength']) {
              <mat-error>
                Major length must be at least
                {{e.controls['major'].errors?.['minlength']['requiredLength']}} characters!
              </mat-error>
              }
              @if (e.controls['major']?.errors?.['maxlength']) {
              <mat-error>
                Major length must be no more than
                {{e.controls['major'].errors?.['maxlength']['requiredLength']}} characters!
              </mat-error>
              }
            </mat-form-field>
          </div>

          <mat-form-field class="full-width mt-4">
            <textarea matInput type="text" placeholder="Main subjects" formControlName="mainSubjects">
          </textarea>
            <mat-hint>Enter Main subjects.</mat-hint>
            @if (e.controls['mainSubjects']?.errors?.['required']) {
            <mat-error>Main subjects field is requred!</mat-error>
            }
            @if (e.controls['mainSubjects']?.errors?.['minlength']) {
            <mat-error>
              Main subjects length must be at least
              {{e.controls['mainSubjects'].errors?.['minlength']['requiredLength']}} characters!
            </mat-error>
            }
            @if (e.controls['mainSubjects']?.errors?.['maxlength']) {
            <mat-error>
              Main subjects length must be no more than
              {{e.controls['mainSubjects'].errors?.['maxlength']['requiredLength']}} characters!
            </mat-error>
            }

          </mat-form-field>

          @if (educationsFormArray.length > 1) {
          <div class="d-flex justify-content-center">
            <button mat-button color="primary" (click)="removeEducationForm(i)">
              Remove
            </button>
          </div>
          }

        </ng-template>
      </mat-expansion-panel>
    </mat-accordion>

  </div>
  }
</form>

<div class="d-flex justify-content-center">
  <button mat-button [disabled]="!educationsForm.valid" (click)="addNewEducationForm()">
    Add new
  </button>
</div>
<div class="d-flex mt-3">
  @if (isEditMode) {
  <button type="submit" class="mx-auto" [disabled]="!educationsForm.valid" mat-button (click)="emitData()">
    Update Info
  </button>
  }
  @else {
  <button type="submit" [disabled]="!educationsForm.valid" mat-button matStepperNext (click)="emitData()">
    Next
  </button>
  }
</div>