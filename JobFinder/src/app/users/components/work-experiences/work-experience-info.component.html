<form [formGroup]="workExpForm">

  @for (workExp of we.controls; track $index; let i = $index) {

  <div [formGroup]="workExp" class="my-4">

    <mat-accordion class="full-width">
      <mat-expansion-panel class="mt-3" [expanded]="openedPanel === i" (opened)="openExpansionPanel(i)">
        <mat-expansion-panel-header>
          <mat-panel-title class="fs-6 fst-italic">
            <span>Work Experience {{i + 1}}</span>
          </mat-panel-title>
        </mat-expansion-panel-header>
        <ng-template matExpansionPanelContent>

          <div class="d-flex justify-content-start gap-3 my-4">
            <mat-form-field class="half-width">
              <input matInput [matDatepicker]="fromDatePicker" placeholder="Choose start date"
                formControlName="fromDate">
              <mat-datepicker-toggle matSuffix [for]="fromDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #fromDatePicker></mat-datepicker>
              <mat-hint>Enter start date.</mat-hint>
              @if (workExp.controls['fromDate']?.touched && workExp.controls['fromDate']?.errors?.['required']) {
              <mat-error>Start date is required!</mat-error>
              }
            </mat-form-field>

            <mat-form-field class="half-width">
              <input matInput [matDatepicker]="toDatePicker" placeholder="Choose end date" formControlName="toDate">
              <mat-datepicker-toggle matSuffix [for]="toDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #toDatePicker></mat-datepicker>
              <mat-hint>Enter end date.</mat-hint>
            </mat-form-field>
          </div>

          <div class="d-flex justify-content-start gap-3 mt-3">
            <mat-form-field class="half-width">
              <input matInput type="text" placeholder="Organization" formControlName="organization">
              <mat-hint>Enter Organization.</mat-hint>
              @if (workExp.controls['organization']?.touched && workExp.controls['organization']?.errors?.['required'])
              {
              <mat-error>Organization is required!</mat-error>
              }
              @if (workExp.controls['organization']?.errors?.['minlength']) {
              <mat-error>Organization length must be at least
                {{workExp.controls['organization'].errors?.['minlength']['requiredLength']}} characters!
              </mat-error>
              }
              @if (workExp.controls['organization'].errors?.['maxlength']) {
              <mat-error>Organization length must be no more than
                {{workExp.controls['organization'].errors?.['maxlength']['requiredLength']}} characters!
              </mat-error>
              }
            </mat-form-field>

            <mat-form-field class="half-width">
              <mat-label>Business sector</mat-label>
              <mat-select formControlName="businessSector" [compareWith]="compareFn">
                @for (bs of businessSectors(); track bs.id) {
                <mat-option [value]="bs">{{ bs.name }}</mat-option>
                }
              </mat-select>
              <mat-hint>Select business sector.</mat-hint>
              @if (workExp.controls['businessSector']?.touched &&
              workExp.controls['businessSector'].errors?.['required']) {
              <mat-error>Business sector is required!</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="d-flex justify-content-start gap-3 my-4">
            <mat-form-field class="half-width">
              <input matInput type="text" placeholder="Location" formControlName="location">
              <mat-hint>Enter Location.</mat-hint>
              @if (workExp.controls['location']?.touched && workExp.controls['location']?.errors?.['required']) {
              <mat-error>Location is required!</mat-error>
              }
              @if (workExp.controls['location']?.errors?.['minlength']) {
              <mat-error>
                Location length must be at least
                {{workExp.controls['location'].errors?.['minlength']['requiredLength']}} Fcharacters!
              </mat-error>
              }
              @if (workExp.controls['location']?.errors?.['maxlength']) {
              <mat-error>
                Location length must be no more than
                {{workExp.controls['location'].errors?.['maxlength']['requiredLength']}} characters!
              </mat-error>
              }
            </mat-form-field>

            <mat-form-field class="half-width">
              <input matInput type="text" placeholder="Job title" formControlName="jobTitle">
              <mat-hint>Enter job title.</mat-hint>
              @if (workExp.controls['jobTitle']?.touched && workExp.controls['jobTitle']?.errors?.['required']) {
              <mat-error>Job title is required!</mat-error>
              }
              @if (workExp.controls['jobTitle']?.errors?.['minlength']) {
              <mat-error>Job title length must be at least
                {{workExp.controls['jobTitle'].errors?.['minlength']['requiredLength']}} characters!
              </mat-error>
              }
              @if (workExp.controls['jobTitle']?.errors?.['maxlength']) {
              <mat-error>
                Job title length must be no more than
                {{workExp.controls['jobTitle'].errors?.['maxlength']['requiredLength']}} characters!
              </mat-error>
              }
            </mat-form-field>
          </div>

          <div class="d-flex mt-3">
            <mat-form-field class="full-width">
              <textarea matInput type="text" placeholder="Additional details" formControlName="additionalDetails">
              </textarea>
              <mat-hint>Enter additional details.</mat-hint>
              @if (workExp.controls['additionalDetails']?.errors?.['minlength']) {
              <mat-error>
                Details length must be at least
                {{workExp.controls['additionalDetails'].errors?.['minlength']['requiredLength']}} characters!
              </mat-error>
              }
              @if (workExp.controls['additionalDetails']?.errors?.['maxlength']) {
              <mat-error>
                Details length must be no more than
                {{workExp.controls['additionalDetails'].errors?.['maxlength']['requiredLength']}} characters!
              </mat-error>
              }
            </mat-form-field>
          </div>

          @if (we.length > 1) {
          <div class="d-flex justify-content-center">
            <button mat-button color="primary" (click)="removeWorkExperienceForm(i)">
              Remove
            </button>
          </div>
          }

        </ng-template>
      </mat-expansion-panel>
    </mat-accordion>

  </div>
  }

  <div class="d-flex justify-content-center">
    <button mat-button color="primary" [disabled]="!workExpForm.valid" (click)="addWorkExperienceForm()">
      Add new
    </button>
  </div>

  <div class="d-flex mt-4">
    @if (isEditMode) {
    <button type="submit" mat-fab extended class="mt-2 mx-auto" color="primary" (click)="emitData()"
      [disabled]="!workExpForm.valid">
      Update Info
    </button>
    }
    @else {
    <button type="submit" mat-button class="mt-2" color="primary" matStepperNext (click)="emitData()"
      [disabled]="!workExpForm.valid">
      Next
    </button>
    }
  </div>

</form>